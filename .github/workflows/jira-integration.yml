name: JIRA Integration

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
  push:
    branches:
      - main

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const jiraPattern = /^\[DOOM-\d+\]/;

            if (!jiraPattern.test(prTitle)) {
              core.setFailed(
                'PR title must start with [DOOM-XXX]\\n\\n' +
                'Examples:\\n' +
                '  [DOOM-123] Add search highlighting functionality\\n' +
                '  [DOOM-456] Fix tree collapse bug\\n\\n' +
                'Your PR title: ' + prTitle
              );
            } else {
              core.info('✓ PR title format is valid: ' + prTitle);
            }

  validate-branch-name:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check branch name format
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const validPattern = /^(feature|bugfix|improvement|docs|refactor)\/DOOM-\d+-.+/;

            if (!validPattern.test(branch)) {
              core.setFailed(
                'Branch name must follow pattern: <type>/DOOM-XXX-<description>\\n\\n' +
                'Valid types: feature, bugfix, improvement, docs, refactor\\n\\n' +
                'Examples:\\n' +
                '  feature/DOOM-123-add-search-functionality\\n' +
                '  bugfix/DOOM-456-fix-tree-collapse\\n\\n' +
                'Your branch: ' + branch
              );
            } else {
              core.info('✓ Branch name format is valid: ' + branch);
            }

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean compile package -DskipTests
        timeout-minutes: 10

      - name: Generate Documentation
        run: |
          javadoc -doclet at.videc.DoomDoclet \
            -docletpath target/classes:target/dependencies/gson-2.8.9.jar \
            -classpath target/dependencies/gson-2.8.9.jar \
            -sourcepath ./src/main/java \
            -subpackages at.videc
        timeout-minutes: 2

      - name: Verify Documentation Output
        run: |
          if [ ! -f "output.html" ]; then
            echo "Error: output.html not generated"
            exit 1
          fi

          if ! grep -q "generateTree" output.html; then
            echo "Error: output.html appears to be incomplete"
            exit 1
          fi

          echo "✓ Documentation generated successfully"
          ls -lh output.html

      - name: Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: output.html
          retention-days: 30

  # Optional: Update JIRA ticket status
  # Requires JIRA_BASE_URL, JIRA_USER_EMAIL, and JIRA_API_TOKEN secrets
  update-jira:
    name: Update JIRA Status
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'closed')
    # Only run if JIRA credentials are configured
    # Remove 'if: false' to enable this job
    continue-on-error: true

    steps:
      - name: Extract JIRA Issue Key
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TITLE="${{ github.event.pull_request.title }}"
            KEY=$(echo "$TITLE" | grep -oP '\[DOOM-\d+\]' | tr -d '[]')
            echo "jira_key=$KEY" >> $GITHUB_OUTPUT
            echo "Found JIRA key: $KEY"
          fi

      - name: Add PR Link to JIRA (requires credentials)
        if: steps.extract.outputs.jira_key != '' && github.event.action == 'opened'
        # Uncomment and configure when JIRA API access is set up
        run: |
          echo "Would add PR link to JIRA ticket: ${{ steps.extract.outputs.jira_key }}"
          echo "PR URL: ${{ github.event.pull_request.html_url }}"
          # Example JIRA API call (requires secrets configuration):
          # curl -X POST "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ steps.extract.outputs.jira_key }}/comment" \
          #   -H "Content-Type: application/json" \
          #   -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
          #   -d "{\"body\": {\"type\": \"doc\", \"version\": 1, \"content\": [{\"type\": \"paragraph\", \"content\": [{\"type\": \"text\", \"text\": \"GitHub PR: ${{ github.event.pull_request.html_url }}\"}]}]}}"

      - name: Transition JIRA to In Review (requires credentials)
        if: steps.extract.outputs.jira_key != '' && github.event.action == 'opened'
        run: |
          echo "Would transition JIRA ticket ${{ steps.extract.outputs.jira_key }} to 'In Review'"
          # Example JIRA transition (requires secrets and correct transition ID):
          # curl -X POST "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ steps.extract.outputs.jira_key }}/transitions" \
          #   -H "Content-Type: application/json" \
          #   -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
          #   -d '{"transition":{"id":"<transition-id-to-in-review>"}}'
